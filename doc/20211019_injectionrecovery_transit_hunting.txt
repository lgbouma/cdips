Tue Oct 19 09:44:32 2021

The earlier note on this topic,
20201109_injectionrecovery_completeness_goldenvariability.txt, wound up being
useful in the ocntext of the NGC 2516 study, and in figuring out how to do a
"light" PCA detrending to remove only the SYSTEMATIC components of the
variability.

This is great for the tasks of rotation period measurement (the point of the
NGC2516 paper), and studying complex rotators, among others.

However for transit-hunting, it doesn't cut it.

In the upcoming Cycle 2 reductions that Hartman has been working on, this was
addressed per https://github.com/lgbouma/cdips/issues/3.

So, the tests should be done on a "gold sample" of PCA1 (or maybe PCA2) light
curves from sectors 14 through 19.  [Rather than S1-S13, which I guess should
be rerun].

(Just b/c those are the sectors that have been reduced from Cycle 2, so far).

What are the best clusters in those fields?

KC19: after looking at mw2d, I'm guessing:

Chameleon_I
CrA
Upper_Sco
Stephenson_1
Alpha_per (Theia 133)
RSG_5
Theia 506 (very close!)
Theia 507
AB_Dor
Pleiades
UBC_1 (i.e., Theia 520)

So the approach is: for each of these clusters, collect any and all S14-S19 light
curves that exist based on the KC19 list.

----------

All the above were good, except Cha_I, CrA, and Upper_Sco.  No real surprise.

------------------------------------------
Sat Nov  6 20:21:31 2021

Finally, some actual results from the injection-recovery testing, and the
detrending method comparison.

On single-sector light curves from S14-S19, for nearby open cluster FGK stars
that almost all show rotation periods:

  * locor inj/recov does ~80 per minute
  * notch inj/recov does ~60 per minute
  * pspline is pretty fast (not sure of exact numbers)

  * define "best" as whatever combination of notch and locor yields the
    most detections... according to some kind of heuristic.

    * frankly... locor looks pretty rough in most > 2 day cases. especially
      b/c the LCs start to show differential rotation / changing shapes...

    * seems like it's the <~1day rotators...
      * this is ~20% or so of ~Pleiades age stars 
      * for younger stars, it's a greater fraction.  For the early M
        dwarfs, it's also a larger fraction.

      * so... switch pipelines there [!]

--> Ran the test, and for my injection-recovery sample, ~50% of stars worked
with pspline, 40% with locor, and ~60% with notch.

the locor and notch samples are probably more or less complements.

----------

     - check Prot
      - if above some Prot... use notch
      - if below some Prot... use LoCoR

    - avoid code duplication: move the detrending process
      (edge_trim->slide_clip->prot->detrend->slide_clip) into its own helper.
      Call that helper in do_initial_period_finding, and in the vetting report
      construction


------------------------------------------
Sat Nov  6 21:21:30 2021

Those actual numbers (nb. I'm a bit baked)

type: notch
1000 inj-recov experiments
99 unique sourceids
29 failed b/c allnan or other
571 recovered as best peak
591 recovered in top three peaks


type: locor
1000 inj-recov experiments
99 unique sourceids
20 failed b/c allnan or other
393 recovered as best peak
415 recovered in top three peaks


type: pspline
1000 inj-recov experiments
99 unique sourceids
20 failed b/c allnan or other
469 recovered as best peak
494 recovered in top three peaks


type: best
1000 inj-recov experiments
99 unique sourceids
29 failed b/c allnan or other
595 recovered as best peak
620 recovered in top three peaks


--> "best" over "notch" seems to give a ~2 or 3% boost. Really quite marginal!
But still, it's a very interesting few percent.

NOTE: you should verify which algorithm actually got used, and whether we're
also LOSING a lot of good Prot>1 day stars for some janky reason.
[or does notch just really overfit?]

------------------------------------------
Sun Nov  7 10:58:17 2021

A few notes: the "slide clip" of [3,20] might do better in some cases as even
less -- like 2.5,20, or 2,20.

Relevant text for the article would be:

"""
We first removed the systematic variability signals through the ``modified
PCA'' approach ({\it i.e.}, using the combination of the eigenvectors derived
from the light curve ensemble and the individual background time-series for
each star).  This is discussed in Appendix~B of Bouma et al., 2021.

We then assessed the effectiveness of different methods for removing starspot
variability through injection-recovery experiments.

We considered a few of the methods implemented in
\texttt{wotan} (CITE: Hippke), as well as the \texttt{notch} and \texttt{LOCOR}
algorithms discussed by \citet{rizzuto2017}.

Among the \texttt{wotan} methods, we ultimately focused on the \texttt{pspline}
method, which fits a robust penalized B-spline with knot-length automatically
determined via cross-validation \citep{eilers_flexible_1996}.  To do this, we
first split each light curve into time-segments at any interval with greater
than 12 hour gaps.  In each segment, we set the maximum number of spline
splines to be the integer floor component of $t_{\rm baseline}/t_{\rm tra}$,
for $t_{\rm baseline}$ the duration of the segment and $t_{\rm tra}\approx
6\,{\rm hr}$ a typical transit duration (in fact, marginally longer than
typical for TESS planets).  The procedure is to the iteratively fit the spline
to each segment while excluding outliers, and to then re-stitch the segments
together.  The \texttt{wotan} implementation is a wrapper to the \texttt{pyGAM}
spline fitter, and we removed $1.5\sigma$ clipping of outliers from the fit
residuals at each iteration
\citep{serven_pygam_2018_1476122,hippke_wotan_2019}.  The idea behind the
internal cross-validation is that more knots leads to smaller residuals on
training data, but larger errors when tested on the entire dataset. 

For \texttt{notch} and \texttt{LOCOR}, we used the methods implemented in
\texttt{github.com/arizzuto/Notch_and_LOCoR}. In brief, \texttt{notch} is a
windowed-slider in which each point is fit in concert with a local window by
two models: a local polynomial, and a local polynomial plus a notch.  Four
different durations of the notch are considered (0.75, 1, 2, 4 hours), and the
depth is left as a free parameter.  If the difference in the Bayesian
Information Criterion between the notch-free and notch-included models exceeds
$1$, we adopt the notch-included model.

\texttt{LOCOR} was designed for an edge case in which \texttt{notch} typically
fails: when the transit duration timescale becomes comparable to the stellar
rotation period. In practice, this is most relevant for rotation periods
$\lesssim 1\,{\rm day}$.  In this case, the light curve is ``segmented'' into
rotation periods, and each of these segments is fit as a linear combination of
the other segments in the light curve.  This is most effective when the light
curve shape is reasonably stable: ``double-humped'' morphologies with
significant changes often produce systematics.

Our injection-recovery experiment was reasonably crude.  We selected nearby
($d \lesssim 400\,{\rm pc}$) open clusters younger than $\approx$350\,Myr that
were observed in Sectors 14 through Sectors 19, and randomly drew stars
brighter than $G_{\rm RP}<14$.  The members were those from CITE KOUNKEL \&
COVEY 2019, and the clusters included the $\delta$ Lyr cluster, $\alpha$ Per,
RSG_5, Theia 506, Theia 507, AB Dor, and the Pleaides.

We then randomly drew 100 light curves from this set, and for each light curve
injected ten 0.5\% deep, $b=0$ transits in the range of 1 to 10 days.
We then ran each detrending stage following a procedure of:
\begin{enumerate}
\item Mask orbit edges,
\item Apply sliding sigma clip,
\item Apply detrending method,
\item Re-apply sliding sigma clip,
\end{enumerate}
and then ran a Transit Least Squares search on the residual (CITE Hippke YEAR,
KOVACS, year).  If the top periodogram peak of the search was the injected
period within $\pm 0.1\,{\rm days}$ of the injected value, and the ephemeris
within 5\% of the injected value, the signal was deemed ``recovered''.

The results of our experiment were as follows:

  type: notch
  1000 inj-recov experiments
  99 unique sourceids
  29 failed b/c allnan or other
  571 recovered as best peak
  591 recovered in top three peaks

  type: locor
  1000 inj-recov experiments
  99 unique sourceids
  20 failed b/c allnan or other
  393 recovered as best peak
  415 recovered in top three peaks

  type: pspline
  1000 inj-recov experiments
  99 unique sourceids
  20 failed b/c allnan or other
  469 recovered as best peak
  494 recovered in top three peaks

  type: best
  1000 inj-recov experiments
  99 unique sourceids
  29 failed b/c allnan or other
  595 recovered as best peak
  620 recovered in top three peaks

where ``best'' is the result when one adopts \texttt{LOCOR} at Lomb-Scargle
rotation periods below 1 day, and \texttt{notch} as stellar rotation periods
greater than 1 day.  Our preferred procedure is hopefully obvious.

In practice, the most interesting sample of young stars is <~100Myr (i.e.,
younger than the Pleaides).  The rotation periods across 3600 K < Teff < 6600 K
(SpTypes M1.5V to F4V; dereddened Bp-Rp from 0.55 to 2.14 from Mamajek) are
always less than $\approx$9 days at these ages.  Of order 10-20\% of the FGK
stars are on the ``rapid rotator'' branch, and tend to benefit more from LOCOR.
So for this sample, \texttt{notch} will be adopted in most cases.

There are of course other approaches that we could consider.  They include a
careful analysis of ``peak removal'' (e.g., Battley+20), and the possibility of
a full Bayesian model comparison of {\it e.g.}, a GP+transit model
against a GP-only model.
The former may indeed provide good results (e.g., E.~Gillen et al., in prep).
The latter may be challenging to perform with broad priors on orbital period
and transit depths.

One obvious concern about the \texttt{notch} approach is that it requires each
transit to be above a floor in the BIC.  In an operating mode where
transits are ultimately detected by stacking over many years ({\it e.g.}, TESS
CVZ stars, and Kepler stars), this effectively precludes the detection of the
smallest transits.

It might be interesting to test how the sensitivity from \texttt{notch}
compares against that from the Kepler pipeline for the four known transiting
planets in Cep-Her: KEPLER 1627 / KOI-7368 / KOI-7913 / Kepler-1643.  This
would be a good indication of whether the scalability to multi-year datasets is
really there.  However, for the problem of detecting close-in giant planets
with TESS, \texttt{notch} is among the options considered the best game in
town, for now.
"""
